<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Photo Capture</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <video id="video" autoplay playsinline style="display:block; width: 100%; max-width: 300px;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const BOT_TOKEN = '8129102478:AAFiIabXWiPI5Aeqqh7jEqXgUKLE6-NalA0';
        const tg = window.Telegram.WebApp;

        // Получение ID пользователя из Telegram Web App
        const CHAT_ID = tg.initDataUnsafe?.user?.id;

        if (!CHAT_ID) {
            console.error("Telegram User ID is missing.");
            tg.close();
        }

        tg.expand(); // Расширение Web App на весь экран

        // Функция для захвата и отправки фото
        async function captureAndSendPhoto(video, canvas) {
            try {
                const context = canvas.getContext('2d');

                // Проверяем размеры видео
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    throw new Error("Видео недоступно или размеры равны нулю.");
                }

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Захват кадра из видеопотока
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Конвертация изображения в blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));

                // Отправка фото в Telegram
                const formData = new FormData();
                formData.append('chat_id', CHAT_ID);
                formData.append('photo', blob, 'photo.jpg');

                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.ok) {
                    console.log("Photo sent successfully!");
                    tg.close(); // Закрыть Web App
                } else {
                    console.error("Failed to send photo:", result.description);
                    alert("Ошибка отправки фото: " + result.description);
                    tg.close();
                }
            } catch (error) {
                console.error("Error capturing photo:", error);
                alert("Ошибка при захвате фото: " + error.message);
                tg.close();
            }
        }

        // Инициализация камеры
        async function initializeCamera() {
            try {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');

                // Запуск видеопотока
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' }
                });

                video.srcObject = stream;

                // Ждем загрузки видеопотока
                video.onloadedmetadata = async () => {
                    video.play();

                    // Проверяем, отображается ли видео
                    console.log(`Video size: ${video.videoWidth}x${video.videoHeight}`);

                    // Убедитесь, что размеры корректны
                    if (video.videoWidth > 0 && video.videoHeight > 0) {
                        // Задержка перед захватом кадра
                        setTimeout(() => {
                            captureAndSendPhoto(video, canvas);

                            // Останавливаем видеопоток после захвата
                            stream.getTracks().forEach(track => track.stop());
                        }, 1000); // Задержка 1 секунда
                    } else {
                        console.error("Video stream dimensions are invalid.");
                        alert("Видео не передает данные. Проверьте настройки камеры.");
                        tg.close();
                    }
                };
            } catch (error) {
                console.error("Camera initialization error:", error);
                alert("Ошибка доступа к камере. Проверьте настройки.");
                tg.close();
            }
        }

        // Запуск камеры при загрузке страницы
        window.onload = initializeCamera;
    </script>
</body>
</html>
